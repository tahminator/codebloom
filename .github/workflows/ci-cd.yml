name: CI/CD
run-name: Running CI/CD on ${{ github.actor }}'s commits

on:
    push:
        branches:
            - main
    pull_request:

permissions:
    contents: write
    issues: write
    pull-requests: write

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    backendPreTest:
        name: Backend Pre Test
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Run backend pre test
              uses: ./.github/composite/test/backend-pre-test

    backendTests:
        name: Backend Tests
        runs-on: ubuntu-latest
        needs: backendPreTest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Disable man-db
              uses: ./.github/composite/disable-mandb

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Set up OpenJDK 25
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "25"
                  cache: "maven"

            - name: Verify Java version
              run: |
                  java -version
                  javac -version
                  echo "JAVA_HOME=$JAVA_HOME"

            - name: Load secrets
              uses: ./.github/composite/load-secrets
              with:
                GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
                GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
                UNLOAD_ENVIRONMENTS: ci-app

            - name: Run script
              run: bash .github/scripts/run-backend-tests.sh

            - name: Upload JaCoCo HTML report
              uses: actions/upload-artifact@v4
              with:
                name: jacoco-report
                path: target/site/jacoco/

            - name: Add JaCoCo PR comment
              id: jacoco
              uses: madrapps/jacoco-report@v1.7.2
              with:
                paths: |
                  target/site/jacoco/jacoco.xml
                token: ${{ secrets.GITHUB_TOKEN }}
                min-coverage-overall: 40
                min-coverage-changed-files: 80
            
            - name: Fail PR if changed files coverage is less than 80%
              if: ${{ steps.jacoco.outputs.coverage-changed-files < 80.0 }}
              uses: actions/github-script@v6
              with:
                script: |
                  core.setFailed('Changed files test coverage is below 80%. Please add or update tests for any new code to meet the required coverage threshold.')
                

    frontendTests:
        name: Frontend Tests
        runs-on: ubuntu-latest
        needs: backendPreTest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Disable man-db
              uses: ./.github/composite/disable-mandb

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Set up OpenJDK 25
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "25"
                  cache: "maven"

            - name: Verify Java version
              run: |
                  java -version
                  javac -version
                  echo "JAVA_HOME=$JAVA_HOME"

            - name: Fix a bug with corepack by installing corepack globally
              run: npm i -g corepack@latest
              working-directory: js

            - name: Load secrets
              uses: ./.github/composite/load-secrets
              with:
                GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
                GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
                UNLOAD_ENVIRONMENTS: ci-app

            - name: Run script
              run: bash .github/scripts/run-frontend-tests.sh

    testBuildImage:
        name: Build Test Docker Image
        runs-on: ubuntu-latest
        needs: backendPreTest

        if: github.ref_name != 'main'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Disable man-db
              uses: ./.github/composite/disable-mandb

            - name: Set up OpenJDK 25
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "25"
                  cache: "maven"

            - name: Verify Java version
              run: |
                  java -version
                  javac -version
                  echo "JAVA_HOME=$JAVA_HOME"

            - name: Load secrets
              uses: ./.github/composite/load-secrets
              with:
                GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
                GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
                UNLOAD_ENVIRONMENTS: ci,ci-app

            - name: Run script
              run: bash .github/scripts/build-image.sh

    validateDBSchema:
        name: Validate DB Schema on Prod DB
        runs-on: ubuntu-latest
        needs: backendPreTest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Disable man-db
              uses: ./.github/composite/disable-mandb

            - name: Set up OpenJDK 25
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "25"
                  cache: "maven"

            - name: Verify Java version
              run: |
                  java -version
                  javac -version
                  echo "JAVA_HOME=$JAVA_HOME"

            - name: Load secrets
              uses: ./.github/composite/load-secrets
              with:
                GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
                GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
                UNLOAD_ENVIRONMENTS: production-ro

            - name: Validate DB Schema
              run: ./mvnw flyway:validate -Dflyway.locations=filesystem:./db/migration -Dflyway.ignoreMigrationPatterns="*:pending"

    buildImage:
        name: Build Docker Image & Upload to Registry
        runs-on: ubuntu-latest
        needs: [validateDBSchema, backendTests, frontendTests]

        if: github.ref_name == 'main'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Disable man-db
              uses: ./.github/composite/disable-mandb

            - name: Set up OpenJDK 25
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "25"
                  cache: "maven"

            - name: Verify Java version
              run: |
                  java -version
                  javac -version
                  echo "JAVA_HOME=$JAVA_HOME"

            - name: Load secrets
              uses: ./.github/composite/load-secrets
              with:
                GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
                GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
                UNLOAD_ENVIRONMENTS: ci,ci-app

            - name: Run script
              run: bash .github/scripts/build-image.sh
              env:
                  SERVER_PROFILES: stg

    redeploy:
        name: Redeploy on DigitalOcean
        runs-on: ubuntu-latest
        needs: buildImage
        environment: production

        if: github.ref_name == 'main'

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Disable man-db
              uses: ./.github/composite/disable-mandb

            - name: Set up OpenJDK 25
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "25"
                  cache: "maven"

            - name: Verify Java version
              run: |
                  java -version
                  javac -version
                  echo "JAVA_HOME=$JAVA_HOME"

            - name: Load secrets
              uses: ./.github/composite/load-secrets
              with:
                GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
                GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
                UNLOAD_ENVIRONMENTS: ci,production

            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                token: ${{ env.DIGITAL_OCEAN_PAT }}

            - name: Migrate Production DB
              run: ./mvnw flyway:migrate -Dflyway.locations=filesystem:./db/migration

            - name: Transform App Spec with secrets
              run: bash .github/scripts/transform-yaml-with-env.sh .do/prod/app.yml .env.production
    
            - name: Update App Spec on DigitalOcean
              run: |
                OUTPUT=$(doctl apps update ${{ env.DIGITAL_OCEAN_APP_ID }} --spec .do/prod/app.yml --update-sources --output json)
                echo "doctl output: $OUTPUT"

                DEPLOYMENT_ID=$(echo "$OUTPUT" | jq -r '.[0].pending_deployment.id // .[0].in_progress_deployment.id // .[0].active_deployment.id // empty' | head -n 1)

                if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" == "null" ]; then
                    echo "Failed to extract deployment ID from app update response"
                    exit 1
                fi

                echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
                  
            - name: Poll Deployment Status
              run: |

                  if [ -z "$DEPLOYMENT_ID" ]; then
                       echo "Deployment ID is empty."
                       exit 1
                  fi

                  echo "Waiting for deployment to be promoted."

                  for i in {1..60}; do
                      RESPONSE=$(curl -s -X GET \
                          -H "Content-Type: application/json" \
                          -H "Authorization: Bearer ${{ env.DIGITAL_OCEAN_PAT }}" \
                          "https://api.digitalocean.com/v2/apps/${{ env.DIGITAL_OCEAN_APP_ID }}/deployments/$DEPLOYMENT_ID")

                      PHASE=$(echo "$RESPONSE" | jq -r '.deployment.phase')

                      echo "Deployment phase: $PHASE"

                      if [ "$PHASE" == "ACTIVE" ]; then
                          echo "Deployment is active."
                          exit 0
                      elif [ "$PHASE" == "SUPERSEDED" ] || [ "$PHASE" == "ERROR" ] || [ "$PHASE" == "CANCELED" ]; then
                          echo "Deployment failed with phase: $PHASE"
                          exit 1
                      fi

                      echo "Waiting for deployment to complete, sleep 10... ($i/60)"
                      sleep 10
                  done

                  echo "Deployment did not reach a valid state within 10 minutes."
                  exit 1
